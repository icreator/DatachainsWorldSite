# -*- coding: utf-8 -*-
# попробовать что-либо вида
try:
    if not IS_LOCAL:
        raise HTTP(501, 'local error')
except:
    pass


CASH_STAR_A = 20

def ball_to_rub():
    h = CAT()
    cntr = 0
    adds = 0
    for r in db(db.men).select():
        if not r.bonus:
            continue
        man_bal = db((db.man_bals.man_id == r.id)
                     & (db.man_bals.cash_id == CASH_STAR_A)).select().first()
        if not man_bal:
            adds +=1
            print '+', adds
            db.man_bals.insert(man_id = r.id, cash_id = CASH_STAR_A, bal = r.bonus)
        else:
            man_bal.update_record(bal = r.bonus)
        
        cntr +=1
        print cntr
    
    h += H3('updated: ', cntr, ' added: ', adds)
    
    return dict(h = DIV(h, _class='container'))
    

def soc_bonus_add():
    man = db.men[ request.args(0) ]
    if not man:
        return 'error'
        
    if request.args(1) == '1':
        man.update_record(social1 = None, bonus = man.bonus + 1)
    else:
        man.update_record(social2 = None, bonus = man.bonus + 1)
        
    return 'DONE'
    
def soc_bonus():
    h = CAT()
    
    for r in db(db.men).select():
        if not r.social1 and not r.social2:
            continue
            
        h += H3(r.name,' ', r.email)
        if r.social1:
            h += DIV(P(A(B(r.social1), _href=r.social1, _target='blank', _class='white')),
                 P(A('ADD BONUS', _onclick = 'ajax("soc_bonus_add/%s/1", [], "%s")' % (r.id, '1_' + r.ref_key),
                    _class='blue')),
                     _id='1_' + r.ref_key)
        if r.social2:
            h += DIV(P(A(B(r.social2), _href=r.social2, _target='blank', _class='white')),
                 P(A('ADD BONUS', _onclick = 'ajax("soc_bonus_add/%s/2", [], "%s")' % (r.id, '2_' + r.ref_key),
                    _class='blue')),
                     _id='2_' + r.ref_key)
        
        h += HR()
    return dict(h = DIV(h, _class='container'))

def index(): return dict(message="hello from tools_soc.py")
